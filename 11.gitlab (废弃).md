| #    | 组件名                | 作用                                 | 默认启停 | 备注               |
| ---- | --------------------- | ------------------------------------ | -------- | ------------------ |
| 1    | **gitaly**            | Git RPC 服务器，真正的仓库存储       | ✅        | 必须，不可关       |
| 2    | **puma**              | Rails Web/GraphQL/API 应用服务器     | ✅        | 必须，不可关       |
| 3    | **sidekiq**           | 后台异步任务队列                     | ✅        | 必须，不可关       |
| 4    | **gitlab-workhorse**  | 反向代理 + 大文件上传/下载路由       | ✅        | 必须，不可关       |
| 5    | **nginx**             | 80/443 前端统一入口                  | ✅        | 可关，改用 Ingress |
| 6    | **registry**          | Docker/Helm 镜像仓库（Distribution） | ✅        | 可关，外接 Harbor  |
| 7    | **pages**             | 静态站点托管                         | ✅        | 可关               |
| 8    | **prometheus**        | 时序指标采集                         | ✅        | 可关，外接 PM      |
| 9    | **grafana**           | 监控仪表盘                           | ✅        | 可关               |
| 10   | **alertmanager**      | 告警发送                             | ✅        | 可关               |
| 11   | **gitlab-exporter**   | GitLab 业务指标导出                  | ✅        | 可关               |
| 12   | **node-exporter**     | 主机系统指标                         | ✅        | 可关               |
| 13   | **redis-exporter**    | Redis 指标（复用外部时可关）         | ✅        | 本次 **关闭**      |
| 14   | **postgres-exporter** | PG 指标（复用外部时可关）            | ✅        | 本次 **关闭**      |
| 15   | **logrotate**         | 日志切割                             | ✅        | 可关               |
| 16   | **gitlab-shell**      | SSH 授权 & 协议转发                  | ✅        | 必须，不可关       |





```shell
sudo mkdir -p /storage/gitlab/{data,log,etc}
sudo chown -R 998:998 /storage/gitlab
```

gitlab-local.yaml

```yaml
---
# 1. 本地 PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-local-pv-data
spec:
  capacity: { storage: 30Gi }
  accessModes: [ ReadWriteOnce ]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-gitlab
  local: { path: /storage/gitlab/data }
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values: [ "izrj943cxeelu8yy8nt47sz" ]
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-local-pv-log
spec:
  capacity: { storage: 10Gi }
  accessModes: [ ReadWriteOnce ]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-gitlab
  local: { path: /storage/gitlab/log }
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values: [ "izrj943cxeelu8yy8nt47sz" ]
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-local-pv-etc
spec:
  capacity: { storage: 1Gi }
  accessModes: [ ReadWriteOnce ]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-gitlab
  local: { path: /storage/gitlab/etc }
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values: [ "izrj943cxeelu8yy8nt47sz" ]
---
# 2. PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-data
  namespace: cicd
spec:
  accessModes: [ ReadWriteOnce ]
  storageClassName: local-gitlab
  resources: { requests: { storage: 30Gi } }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-log
  namespace: cicd
spec:
  accessModes: [ ReadWriteOnce ]
  storageClassName: local-gitlab
  resources: { requests: { storage: 10Gi } }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-etc
  namespace: cicd
spec:
  accessModes: [ ReadWriteOnce ]
  storageClassName: local-gitlab
  resources: { requests: { storage: 1Gi } }
---
# 3. Secret（root 密码）
apiVersion: v1
kind: Secret
metadata:
  name: gitlab-secret
  namespace: cicd
type: Opaque
stringData:
  password: "gItlab123456_"
---
# 4. ConfigMap（gitlab.rb）
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-config
  namespace: cicd
data:
  gitlab.rb: |
    external_url 'http://47.88.85.25:30080'
    gitlab_rails['gitlab_shell_ssh_port'] = 30081

    postgresql['enable'] = false
    gitlab_rails['db_adapter']  = 'postgresql'
    gitlab_rails['db_encoding'] = 'unicode'
    gitlab_rails['db_database'] = 'gitlab'
    gitlab_rails['db_pool']     = 10
    gitlab_rails['db_host']     = 'pg.mid.svc.cluster.local'
    gitlab_rails['db_port']     = 5432
    gitlab_rails['db_username'] = 'postgres'
    gitlab_rails['db_password'] = 'pG123456_'

    redis['enable'] = false
    gitlab_rails['redis_host'] = 'redis.mid.svc.cluster.local'
    gitlab_rails['redis_port'] = 6379
    gitlab_rails['redis_password'] = 'rEdis123456_'
    
    prometheus['enable'] = false
    alertmanager['enable'] = false
    
    nginx['enable'] = true
    registry['enable'] = true
    gitlab_pages['enable'] = true
    gitlab_exporter['enable'] = true
    node_exporter['enable'] = true
    redis_exporter['enable'] = false
    postgres_exporter['enable'] = false

    registry_external_url 'http://47.88.85.25:30082'
    pages_external_url    'http://47.88.85.25:30083'

    gitlab_exporter['listen_port'] = 9168
---
# 5. Service
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  namespace: cicd
spec:
  type: NodePort
  selector: { app: gitlab }
  ports:
    - port: 80
      targetPort: 8080
      nodePort: 30080
      name: http
    - port: 22
      targetPort: 22
      nodePort: 30081
      name: ssh
    - port: 5000
      targetPort: 5000
      nodePort: 30082
      name: registry
    - port: 8090
      targetPort: 8090
      nodePort: 30083
      name: pages
    - port: 9168
      targetPort: 9168
      nodePort: 30084
      name: metrics
---
# 6. Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  namespace: cicd
spec:
  replicas: 1
  selector:
    matchLabels: { app: gitlab }
  template:
    metadata:
      labels: { app: gitlab }
    spec:
      nodeSelector:
        kubernetes.io/hostname: izrj943cxeelu8yy8nt47sz
      initContainers:
        - name: fix-perm
          image: busybox:1.36
          command: [ 'sh','-c','chown -R 998:998 /var/opt/gitlab /var/log/gitlab /etc/gitlab' ]
          volumeMounts:
            - name: data
              mountPath: /var/opt/gitlab
            - name: data-log
              mountPath: /var/log/gitlab
            - name: data-etc
              mountPath: /etc/gitlab
      containers:
        - name: gitlab
          image: gitlab/gitlab-ce:17.7.0-ce.0
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 22
              name: ssh
            - containerPort: 5000
              name: registry
            - containerPort: 8090
              name: pages
            - containerPort: 9168
              name: metrics
          env:
            - name: GITLAB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: gitlab-secret
                  key: password
          volumeMounts:
            - name: data
              mountPath: /var/opt/gitlab
            - name: data-log
              mountPath: /var/log/gitlab
            - name: data-etc
              mountPath: /etc/gitlab
            - name: config
              mountPath: /etc/gitlab/gitlab.rb
              subPath: gitlab.rb
          startupProbe: # 探测容器是否“已启动”，成功前 liveness/readiness 不生效
            httpGet: # 采用 HTTP GET 方式探活
              path: /-/health         # 向容器 8080 端口的 /-/health 发请求
              port: 8080
            initialDelaySeconds: 0    # 容器一就绪立即开始探测，不额外等待
            periodSeconds: 10         # 每 10 秒探测一次
            timeoutSeconds: 10        # 单次请求 10 秒内必须响应，否则算失败
            failureThreshold: 60      # 连续失败 60 次才杀死容器，累计最多给 10×60=600 秒（10 分钟）启动窗口
            successThreshold: 1       # 只要一次成功即视为“已启动”，立即退出 startupProbe
          
          livenessProbe: # 负责运行期“活探”，失败则重启容器
            httpGet:
              path: /-/health         # 同样访问 /-/health
              port: 8080
            initialDelaySeconds: 0    # 由 startupProbe 接管启动阶段，此处无需再等待
            periodSeconds: 10         # 每 10 秒探测一次
            timeoutSeconds: 10        # 单次超时 10 秒
            failureThreshold: 3       # 连续 3 次失败 → 30 秒内重启容器
          
          readinessProbe: # 负责运行期“就绪探”，失败则从 Service Endpoints 摘流
            httpGet:
              path: /-/readiness      # 专门检查业务是否准备好接收流量
              port: 8080
            initialDelaySeconds: 0    # 同样无需等待，startupProbe 通过后立即生效
            periodSeconds: 5          # 每 5 秒探测一次，比 liveness 更频繁，确保流量快速切换
            timeoutSeconds: 10        # 单次超时 10 秒
            failureThreshold: 3       # 连续 3 次失败 → 15 秒内 Pod 被标记为 NotReady，流量不再转发到本 Pod
          resources:
            requests: { cpu: "1", memory: "4Gi" }
            limits: { cpu: "2", memory: "8Gi" }
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: gitlab-data }
        - name: data-log
          persistentVolumeClaim: { claimName: gitlab-log }
        - name: data-etc
          persistentVolumeClaim: { claimName: gitlab-etc }
        - name: config
          configMap:
            name: gitlab-config
            defaultMode: 0600
```

add-prometheus-config.yaml

```
# 给 mon/prometheus 加抓取任务（apply 到 mon 空间即可）
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config-add
  namespace: mon
data:
  gitlab.yml: |
    scrape_configs:
      - job_name: 'gitlab'
        static_configs:
        - targets: ['10.0.1.245:30168']  # GitLab exporter NodePort
        metrics_path: /metrics
        scrape_interval: 15s
      - job_name: 'gitlab-pages'
        static_configs:
        - targets: ['10.0.1.245:30501']  # Pages 指标端口
        metrics_path: /metrics
        scrape_interval: 15s
```

```shell
# 1. 创建数据库（一次性）
kubectl -n mid exec -it deployment/postgres -- psql -U postgres -c "CREATE DATABASE gitlab OWNER postgres;"

# 2. 部署 GitLab（全部组件开启）
kubectl apply -f 01-gitlab-mon.yaml

# 3. 给 Prometheus 加抓取任务
kubectl -n mon patch configmap prometheus-config --patch "$(kubectl -n mon get cm prometheus-config-add -o json | jq '.data')"
# 或直接 kubectl apply -f 02-add-prometheus-config.yaml 然后重启 Prometheus Pod（发送 SIGHUP 或 delete Pod）



```

```
# 端口验证
ssh -T git@<任一节点IP> -p 30081   # 应返回 Welcome to GitLab
docker login <节点IP>:30082       # 用户 root / gItlab123456_
```



```
# GitLab 就绪
kubectl -n cicd get pod -l app=gitlab -w

# Prometheus 抓到新指标
curl http://10.0.1.245:30090/targets
# 应出现 gitlab、gitlab-pages UP 状态

# Grafana 导入模板
# 模板 ID 11016（GitLab Omnibus）或 10991（RabbitMQ）
```

| 功能            | 节点端口                    |
| --------------- | --------------------------- |
| GitLab Web      | 30080                       |
| Git SSH         | 30022                       |
| Registry        | 30500                       |
| Pages           | 30501                       |
| GitLab Exporter | 30168（仅 Prometheus 调用） |

```
kubectl -n cicd run tmp --rm -it --image=busybox --restart=Never -- \
  sh -c 'nc -zv pg.mid.svc.cluster.local 5432 && nc -zv redis.mid.svc.cluster.local 6379'
```

