mysql-8.4.6-localpv-all.yaml

```yaml
#########################################
# 01 主库 PV（LocalPV）
#########################################
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-master-pv
spec:
  capacity: { storage: 480Gi }
  accessModes: [ ReadWriteOnce ]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: mysql-local-ssd
  local:
    path: /storage/mysql/master          # 节点需提前挂载好 /dev/nvme1n1p1
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values: ["izrj943cxeelu84r2mp9abz"]         # << 改成主库节点名

---
#########################################
# 02 从库 PV（LocalPV）
#########################################
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-slave-pv
spec:
  capacity: { storage: 480Gi }
  accessModes: [ ReadWriteOnce ]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: mysql-local-ssd
  local:
    path: /storage/mysql/slave
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values: ["izrj943cxeelu84r2mp9acz"]         # << 改成从库节点名

---
#########################################
# 03 密钥
#########################################
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: mid
type: Opaque
stringData:
  root-password: "mYsql123456_"   # << 自定义
  repl-password: "mYsql123456_"   # << 自定义

---
#########################################
# 04 主库配置
#########################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-master-conf
  namespace: mid
data:
  master.cnf: |
    [mysqld]
    server-id=1
    binlog_format=ROW
    log-bin=mysql-bin
    gtid_mode=ON
    enforce_gtid_consistency=ON
    innodb_flush_log_at_trx_commit=1
    sync_binlog=1
    #rpl_semi_sync_source_enabled=ON
    #rpl_semi_sync_source_timeout=5000
    innodb_buffer_pool_size=1G   # 按节点内存 70% 调
    max_connections=2000

---
#########################################
# 05 从库配置
#########################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-slave-conf
  namespace: mid
data:
  slave.cnf: |
    [mysqld]
    server-id=2
    relay_log=relay-bin
    read_only=1
    gtid_mode=ON
    enforce_gtid_consistency=ON
    #rpl_semi_sync_replica_enabled=ON
    innodb_buffer_pool_size=2G
    max_connections=2000

---
#########################################
# 06 主库 Service
#########################################
apiVersion: v1
kind: Service
metadata:
  name: mysql-master
  namespace: mid
spec:
  ports:
  - port: 3306
  selector:
    app: mysql-master

---
#########################################
# 07 从库 Service
#########################################
apiVersion: v1
kind: Service
metadata:
  name: mysql-slave
  namespace: mid
spec:
  ports:
  - port: 3306
  selector:
    app: mysql-slave

---
#########################################
# 08 主库 StatefulSet（8.4.6）
#########################################
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-master
  namespace: mid
spec:
  serviceName: mysql-master
  replicas: 1
  selector:
    matchLabels: { app: mysql-master }
  template:
    metadata:
      labels: { app: mysql-master }
    spec:
      nodeName: izrj943cxeelu84r2mp9abz              # << 锚定主节点
      containers:
      - name: mysql
        image: mysql:8.4.0
        imagePullPolicy: IfNotPresent
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef: { name: mysql-secret, key: root-password }
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: config
          mountPath: /etc/mysql/conf.d
        resources:
          requests: { cpu: "2", memory: "4Gi" }
          limits:   { cpu: "4", memory: "4Gi" }
        livenessProbe: &livenessProbe
          exec:
            command: ["mysqladmin", "ping", "-hlocalhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe: *livenessProbe
      volumes:
      - name: mysql-data
        persistentVolumeClaim:
          claimName: mysql-master-pvc
      - name: config
        configMap: { name: mysql-master-conf, items: [ { key: master.cnf, path: master.cnf } ] }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-master-pvc
  namespace: mid
spec:
  accessModes: [ ReadWriteOnce ]
  storageClassName: mysql-local-ssd
  resources: { requests: { storage: 480Gi } }
  volumeName: mysql-master-pv

---
#########################################
# 09 从库 StatefulSet（8.4.6）
#########################################
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-slave
  namespace: mid
spec:
  serviceName: mysql-slave
  replicas: 1
  selector:
    matchLabels: { app: mysql-slave }
  template:
    metadata:
      labels: { app: mysql-slave }
    spec:
      nodeName: izrj943cxeelu84r2mp9acz               # << 锚定从节点
      containers:
      - name: mysql
        image: mysql:8.4.0
        imagePullPolicy: IfNotPresent
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef: { name: mysql-secret, key: root-password }
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: config
          mountPath: /etc/mysql/conf.d
        resources:
          requests: { cpu: "2", memory: "4Gi" }
          limits:   { cpu: "4", memory: "4Gi" }
        livenessProbe: &livenessProbe
          exec:
            command: ["mysqladmin", "ping", "-hlocalhost", "-uroot", "-p${MYSQL_ROOT_PASSWORD}"]
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe: *livenessProbe
      volumes:
      - name: mysql-data
        persistentVolumeClaim:
          claimName: mysql-slave-pvc
      - name: config
        configMap: { name: mysql-slave-conf, items: [ { key: slave.cnf, path: slave.cnf } ] }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-slave-pvc
  namespace: mid
spec:
  accessModes: [ ReadWriteOnce ]
  storageClassName: mysql-local-ssd
  resources: { requests: { storage: 480Gi } }
  volumeName: mysql-slave-pv

---
#########################################
# 10 主从复制初始化 Job（2025 推荐版）
#########################################
apiVersion: batch/v1
kind: Job
metadata:
  name: init-replica-stream-v2
  namespace: mid
spec:
  template:
    spec:
      restartPolicy: Never
      nodeName: izrj943cxeelu84r2mp9acz
      initContainers:
      # 0. 等主库
      - name: wait-master
        image: mysql:8.4.0
        env:
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef: {name: mysql-secret, key: root-password}
        command: ["bash","-c","until mysql -hmysql-master.mid -uroot -p$MYSQL_PWD -e 'select 1;';do sleep 5;done"]
      # 1. 等从库
      - name: wait-slave
        image: mysql:8.4.0
        env:
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef: {name: mysql-secret, key: root-password}
        command: ["bash","-c","until mysql -hmysql-slave.mid   -uroot -p$MYSQL_PWD -e 'select 1;';do sleep 5;done"]
      # 2. 预启动 socat，只 accept 一次就退出（initContainers 会卡住直到它成功）
      - name: socat-handshake
        image: percona/percona-xtrabackup:8.4.0-1
        command:
        - socat
        - TCP-LISTEN:8024,reuseaddr
        - EXEC:/bin/true              # 收到连接后立即结束
        resources: {}                 # 几乎不占资源

      containers:
      # 3. 备份端
      - name: backup
        image: percona/percona-xtrabackup:8.4.0-1
        env:
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef: {name: mysql-secret, key: root-password}
        command:
        - bash
        - -ec
        - |
          set -e
          xtrabackup --backup --slave-info --stream=xbstream \
            --host=mysql-master.mid.svc.cluster.local \
            --user=root --password=$MYSQL_PWD \
            --no-lock --safe-slave-backup \
            --datadir=/var/lib/mysql > /dev/tcp/127.0.0.1/8024
      # 4. 恢复端
      - name: restore
        image: percona/percona-xtrabackup:8.4.0-1
        env:
        - name: MYSQL_PWD
          valueFrom:
            secretKeyRef: {name: mysql-secret, key: root-password}
        command:
        - bash
        - -ec
        - |
          set -e
          # 真正接收数据
          socat -u TCP-LISTEN:8024,reuseaddr - | xbstream -x -C /var/lib/mysql
          xtrabackup --prepare --apply-log-only --datadir=/var/lib/mysql
          mysql -hmysql-slave.mid -uroot -p$MYSQL_PWD <<EOF
          STOP REPLICA; RESET REPLICA ALL;
          CHANGE REPLICATION SOURCE TO
            SOURCE_HOST='mysql-master.mid.svc.cluster.local',
            SOURCE_USER='root',
            SOURCE_PASSWORD='$MYSQL_PWD',
            SOURCE_AUTO_POSITION=1;
          START REPLICA; SHOW REPLICA STATUS\G
          EOF
        volumeMounts:
        - name: slave-data
          mountPath: /var/lib/mysql
        ports:
        - containerPort: 8024
          protocol: TCP

      volumes:
      - name: slave-data
        persistentVolumeClaim:
          claimName: mysql-slave-pvc
```





```shell
# 1. 节点提前挂盘 & 创建 /mnt/mysql/{master,slave} 并 chown 999:999
# chown -R 999:999 /mnt/mysql/master    # mysql 镜像默认 UID 999
# chmod 700 /mnt/mysql/master
# 2. 替换文件内节点名、密码
kubectl apply -f mysql-8.4.6-localpv-all.yaml
# 3. 等待 master/slave Pod Running 后
kubectl -n mid logs -f job/init-replica-846
# 4. 验证
kubectl exec -it -n mid mysql-master-0 -- mysql -uroot -pProd#123456 -e "CREATE DATABASE mid; USE mid; CREATE TABLE t1(id int); INSERT INTO t1 VALUES(1);"
kubectl exec -it -n mid mysql-slave-0 -- mysql -uroot -pProd#123456 -e "SELECT * FROM mid.t1;"   # 能看到 1


kubectl delete -f mysql-8.4.6-localpv-all.yaml
```





```
kubectl -n mid get pv
kubectl -n mid get secret
kubectl -n mid get ConfigMap
kubectl -n mid get Service
kubectl -n mid get sts
kubectl -n mid get pod
kubectl describe pod init-replica-stream-v2-kvlcf -n mid
kubectl logs init-replica-stream-v2-kvlcf -n mid


kubectl get pods -n mid | grep 'init' | awk '{print $1}' | \
xargs kubectl delete pod -n mid
```





