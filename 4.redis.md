```bash
sudo mkdir -p /storage/redis
sudo chown -R 999:999 /storage/redis
```



放在 worker 1

redis-local.yaml

```
# redis-local.yaml
---
# 1. 本地持久卷（提前准备好的节点目录）
apiVersion: v1
kind: PersistentVolume
metadata:
  name: redis-local-pv
spec:
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-redis
  local:
    path: /storage/redis          # 节点本地路径
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - izrj943cxeelu84r2mp9acz        # <-- 改成你的节点名

---
# 2. PVC（命名空间 mid）
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-data
  namespace: mid
spec:
  accessModes: [ "ReadWriteOnce" ]
  storageClassName: local-redis
  resources:
    requests:
      storage: 5Gi

---
# 3. 密码 Secret
apiVersion: v1
kind: Secret
metadata:
  name: redis-auth
  namespace: mid
type: Opaque
stringData:
  password: "rEdis123456_"

---
# 4. Redis 单副本 Deployment + NodePort Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: mid
spec:
  replicas: 1
  selector:
    matchLabels: { app: redis }
  template:
    metadata:
      labels: { app: redis }
    spec:
      nodeSelector: # 与 PV 同节点
        kubernetes.io/hostname: izrj943cxeelu84r2mp9acz
      containers:
        - name: redis
          image: redis:7-alpine
          command:
            - sh
            - -c
            - |
              redis-server \
               --requirepass $(REDIS_PASSWORD) \
               --appendonly yes \
               --dir /data
          env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-auth
                  key: password
          ports:
            - containerPort: 6379
          volumeMounts:
            - name: data
              mountPath: /data
          livenessProbe:
            tcpSocket: { port: 6379 }
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            tcpSocket: { port: 6379 }
            initialDelaySeconds: 3
            periodSeconds: 3
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: redis-data
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: mid
spec:
  type: NodePort
  ports:
    - port: 6379
      targetPort: 6379
      nodePort: 32379
  selector: { app: redis }
```





```
kubectl apply -f redis-local.yaml
kubectl -n mid get pod
```

