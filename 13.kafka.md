- 命名空间：**mid**（与 RabbitMQ、Nacos、Consul 并存）
- 镜像：**bitnami/kafka:3.8.1**（开箱即用，无需额外 ZooKeeper，自带 KRaft 模式）
- 本地路径 `/storage/kafka`
- NodePort 暴露：
  - 9092 → 30992（Kafka 客户端端口）
  - 9093 → 30993（Controller 内部通信，可忽略）
- **Prometheus 指标自动开启**（JMX Exporter 已内置）
- **与 RabbitMQ 松耦合**：业务代码按需选择消息中间件



```
sudo mkdir -p /storage/kafka/data
sudo chown -R 1001:1001 /storage/kafka   # bitnami 镜像默认 UID
```

kafka-local.yaml

```
# 0. 命名空间（沿用 mid）
apiVersion: v1
kind: Namespace
metadata:
  name: mid
---
# 1. 本地 PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: kafka-local-pv
spec:
  capacity: { storage: 20Gi }
  accessModes: [ReadWriteOnce]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-kafka
  local: { path: /storage/kafka }
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values: ["izrj943cxeelu84r2mp9abz"]
---
# 2. PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: kafka-data
  namespace: mid
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: local-kafka
  resources: { requests: { storage: 20Gi } }
---
# 3. Service
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: mid
spec:
  type: NodePort
  ports:
  - port: 9092
    targetPort: 9092
    nodePort: 30992
    name: kafka-client
  - port: 9093
    targetPort: 9093
    nodePort: 30993
    name: kafka-controller
  selector: { app: kafka }
---
# 4. Deployment（KRaft 单节点模式）
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka
  namespace: mid
spec:
  replicas: 1
  selector:
    matchLabels: { app: kafka }
  template:
    metadata:
      labels: { app: kafka }
    spec:
      nodeSelector: { kubernetes.io/hostname: izrj943cxeelu84r2mp9abz }
      containers:
      - name: kafka
        image: bitnami/kafka:3.8.1
        ports:
        - containerPort: 9092
          name: kafka-client
        - containerPort: 9093
          name: kafka-controller
        env:
        - name: KAFKA_ENABLE_KRAFT
          value: "yes"
        - name: KAFKA_KRAFT_CLUSTER_ID
          value: "MkU3OEVBNTcwNTJENDM2Qk"   # 任意 16 字节 Base64
        - name: KAFKA_NODE_ID
          value: "1"
        - name: KAFKA_CONTROLLER_QUORUM_VOTERS
          value: "1@127.0.0.1:9093"
        - name: KAFKA_LISTENERS
          value: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://10.0.1.245:30992"   # 节点 IP + NodePort
        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
          value: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
        - name: KAFKA_CONTROLLER_LISTENER_NAMES
          value: "CONTROLLER"
        - name: KAFKA_LOG_DIRS
          value: "/bitnami/kafka/data"
        - name: KAFKA_METRICS_ENABLED
          value: "true"
        - name: JMX_PORT
          value: "9999"
        volumeMounts:
        - name: data
          mountPath: /bitnami/kafka/data
        livenessProbe:
          tcpSocket:
            port: 9092
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 9092
          initialDelaySeconds: 5
          periodSeconds: 5
        resources:
          requests: { cpu: "500m", memory: "1Gi" }
          limits: { cpu: "2", memory: "2Gi" }
      volumes:
      - name: data
        persistentVolumeClaim: { claimName: kafka-data }
```

```bash
kubectl apply -f kafka-local.yaml
```

Prometheus 抓取（已有 mon/prometheus）

```
# 02-add-kafka-prometheus.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config-add
  namespace: mon
data:
  kafka.yml: |
    scrape_configs:
      - job_name: 'kafka'
        static_configs:
        - targets: ['10.0.1.245:9999']   # JMX 指标端口
        metrics_path: /metrics
```



```
# 等待 Pod Ready
kubectl -n mid get pod -l app=kafka -w

# 创建 topic 测试
kubectl -n mid exec -it deployment/kafka -- \
  kafka-topics.sh --create --topic demo --partitions 1 --replication-factor 1 \
  --bootstrap-server 10.0.1.245:30992

# 生产 / 消费消息
kubectl -n mid exec -it deployment/kafka -- \
  kafka-console-producer.sh --topic demo --bootstrap-server 10.0.1.245:30992

kubectl -n mid exec -it deployment/kafka -- \
  kafka-console-consumer.sh --topic demo --from-beginning --bootstrap-server 10.0.1.245:30992
```



| 功能             | 节点端口                      |
| ---------------- | ----------------------------- |
| Kafka 客户端     | 30992                         |
| Kafka Controller | 30993                         |
| JMX 指标         | 9999（Pod 内，可再 NodePort） |

