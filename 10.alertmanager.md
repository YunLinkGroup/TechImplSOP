```shell
sudo mkdir -p /storage/alertmanager
sudo chown -R 65534:65534 /storage/alertmanager
```



alertmanager-local.yaml

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: alertmanager-local-pv
spec:
  capacity: { storage: 5Gi }
  accessModes: ["ReadWriteOnce"]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-alertmanager
  local: { path: /storage/alertmanager }
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
            - izrj943cxeelu8yy8nt47tz

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: alertmanager-data
  namespace: mon
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-alertmanager
  resources: { requests: { storage: 5Gi } }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: mon
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
    receivers:
    - name: 'web.hook'
      webhook_configs:
      - url: 'http://example.com/webhook'   # 后续改成真实地址
        send_resolved: true

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: mon
spec:
  replicas: 1
  selector:
    matchLabels: { app: alertmanager }
  template:
    metadata:
      labels: { app: alertmanager }
    spec:
      nodeSelector: { kubernetes.io/hostname: izrj943cxeelu8yy8nt47tz }
      initContainers:
      - name: fix-perm
        image: busybox:1.36
        command: ['sh','-c','chown -R 65534:65534 /alertmanager']
        volumeMounts: [{ name: data, mountPath: /alertmanager }]
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.27.0
        args:
        - '--config.file=/etc/alertmanager/alertmanager.yml'
        - '--storage.path=/alertmanager'
        - '--web.external-url=http://10.0.1.245:30093'
        ports:
        - containerPort: 9093
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
        - name: data
          mountPath: /alertmanager
        resources:
          requests: { cpu: "50m", memory: "128Mi" }
          limits: { cpu: "200m", memory: "256Mi" }
      volumes:
      - name: config
        configMap: { name: alertmanager-config }
      - name: data
        persistentVolumeClaim: { claimName: alertmanager-data }

---
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: mon
spec:
  type: NodePort
  ports:
  - port: 9093
    targetPort: 9093
    nodePort: 30070
  selector: { app: alertmanager }
```



```shell
kubectl apply -f alertmanager-local.yaml
kubectl get pod -n mon
```



alertmanager.yml

```yaml
global:
  resolve_timeout: 5m

  # 腾讯企业邮 SMTP 信息
  smtp_smarthost: 'smtp.exmail.qq.com:465'
  smtp_from: 'xxx@xxx.com'        # 发件人
  smtp_auth_username: 'xxx@xxx.com' # 登录用户名
  smtp_auth_password: 'gO123456_'       # 企业邮“客户端授权码”
  smtp_require_tls: false                    # 关闭 STARTTLS，直接用 SSL
route:
  group_by: [ 'cluster', 'service', 'alertname' ]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h
  receiver: default
receivers:
  - name: 'default'
    email_configs:
      - to: 'xxx@xxx.com'               # 告警收件箱
        send_resolved: true                      # 故障恢复时发送恢复邮件
        headers:
          Subject: '[Prometheus] {{ .GroupLabels.alertname }} 告警'
        html: '{{ template "email.default.html" . }}'  # 使用内置模板，也可自定义
inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: [ 'cluster', 'service', 'alertname' ]
```

