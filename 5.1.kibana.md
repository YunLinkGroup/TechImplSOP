无需本地持久化，kibana 核心数据存储在 es 中



```shell
kubectl -n mid exec -i es-6cbdf78f6f-kndtq -- bash -c \
  "curl -s -u elastic:\$ELASTIC_PASSWORD -X POST localhost:9200/_security/service/elastic/kibana/credential/token/k8s-kibana-token -H 'Content-Type: application/json'"
```

删除令牌

```
kubectl -n mid exec -i es-6cbdf78f6f-kndtq -- bash -c \
  "curl -s -u elastic:\$ELASTIC_PASSWORD -X DELETE \
  localhost:9200/_security/service/elastic/kibana/credential/token/k8s-kibana-token"
```





AAEAAWVsYXN0aWMva2liYW5hL2s4cy1raWJhbmEtdG9rZW46eG42UWZLdklTTzJtNjh0YXlJQ2lGQQ



kibana-local.yaml

```yaml
---
# 1. Kibana 配置 ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-config
  namespace: mid
data:
  kibana.yml: |
    server.name: kibana
    server.host: 0.0.0.0
    server.port: 5601
    server.publicBaseUrl: "http://47.88.85.25:30022"   # http://<你的节点IP>:port,如不需要可删掉
    #elasticsearch.hosts: ["http://es:9200"]            # 通过集群 DNS 直接连 ES
    #elasticsearch.username: "elastic"
    #elasticsearch.password: "eS123456_"
    #elasticsearch.ssl.verificationMode: "none"         # 集群内部无 HTTPS
    logging.root.level: info
    #elasticsearch.ssl.certificateAuthorities: [/usr/local/kibana/data/ca_1758251000763.crt]
    #elasticsearch.serviceAccountToken: AAEAAWVsYXN0aWMva2liYW5hL2Vucm9sbC1wcm9jZXNzLXRva2VuLTE3NTgyNTA5OTk0Nzc6SVpMSWZjR0dTT3lhTzg1b1NfYmFJdw
---
# 2. Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  namespace: mid
spec:
  replicas: 1
  selector:
    matchLabels: { app: kibana }
  template:
    metadata:
      labels: { app: kibana }
    spec:
      # 与 ES 跑在同一节点，方便本地路径复用（可选）
      nodeSelector:
        kubernetes.io/hostname: izrj943cxeelu8yy8nt47sz
      containers:
        - name: kibana
          image: docker.elastic.co/kibana/kibana:8.17.3
          ports:
            - containerPort: 5601
              name: http
          env:
            - name: ELASTICSEARCH_HOSTS
              value: "http://es:9200"
            - name: ELASTICSEARCH_SERVICEACCOUNTTOKEN
              value: AAEAAWVsYXN0aWMva2liYW5hL2s4cy1raWJhbmEtdG9rZW46eG42UWZLdklTTzJtNjh0YXlJQ2lGQQ
            #- name: ELASTICSEARCH_USERNAME
            #  value: "elastic"
            #- name: ELASTICSEARCH_PASSWORD
            #  value: "eS123456_"
          volumeMounts:
            - name: config
              mountPath: /usr/share/kibana/config/kibana.yml
              subPath: kibana.yml
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /api/status
              port: 5601
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/status
              port: 5601
            initialDelaySeconds: 30
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: kibana-config
---
# 3. Service
apiVersion: v1
kind: Service
metadata:
  name: kibana
  namespace: mid
spec:
  type: NodePort
  ports:
    - port: 5601
      targetPort: 5601
      nodePort: 30022   # 浏览器访问 <节点IP>:30022
      name: http
  selector: { app: kibana }
```

```shell
kubectl apply -f kibana-local.yaml
kubectl -n mid get pod
```

