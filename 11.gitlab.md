| #    | 组件名                | 作用                                 | 默认启停 | 备注               |
| ---- | --------------------- | ------------------------------------ | -------- | ------------------ |
| 1    | **gitaly**            | Git RPC 服务器，真正的仓库存储       | ✅        | 必须，不可关       |
| 2    | **puma**              | Rails Web/GraphQL/API 应用服务器     | ✅        | 必须，不可关       |
| 3    | **sidekiq**           | 后台异步任务队列                     | ✅        | 必须，不可关       |
| 4    | **gitlab-workhorse**  | 反向代理 + 大文件上传/下载路由       | ✅        | 必须，不可关       |
| 5    | **nginx**             | 80/443 前端统一入口                  | ✅        | 可关，改用 Ingress |
| 6    | **registry**          | Docker/Helm 镜像仓库（Distribution） | ✅        | 可关，外接 Harbor  |
| 7    | **pages**             | 静态站点托管                         | ✅        | 可关               |
| 8    | **prometheus**        | 时序指标采集                         | ✅        | 可关，外接 PM      |
| 9    | **grafana**           | 监控仪表盘                           | ✅        | 可关               |
| 10   | **alertmanager**      | 告警发送                             | ✅        | 可关               |
| 11   | **gitlab-exporter**   | GitLab 业务指标导出                  | ✅        | 可关               |
| 12   | **node-exporter**     | 主机系统指标                         | ✅        | 可关               |
| 13   | **redis-exporter**    | Redis 指标（复用外部时可关）         | ✅        | 本次 **关闭**      |
| 14   | **postgres-exporter** | PG 指标（复用外部时可关）            | ✅        | 本次 **关闭**      |
| 15   | **logrotate**         | 日志切割                             | ✅        | 可关               |
| 16   | **gitlab-shell**      | SSH 授权 & 协议转发                  | ✅        | 必须，不可关       |





```
sudo mkdir -p /storage/gitlab
sudo chown -R 998:998 /storage/gitlab
```

gitlab-mon.yaml

```
# 0. 命名空间
apiVersion: v1
kind: Namespace
metadata:
  name: cicd
---
# 1. 本地 PV
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-local-pv
spec:
  capacity: { storage: 30Gi }
  accessModes: [ReadWriteOnce]
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-gitlab
  local: { path: /storage/gitlab }
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values: ["izrj943cxeelu84r2mp9abz"]
---
# 2. PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-data
  namespace: cicd
spec:
  accessModes: [ReadWriteOnce]
  storageClassName: local-gitlab
  resources: { requests: { storage: 30Gi } }
---
# 3. Secret（root 密码）
apiVersion: v1
kind: Secret
metadata:
  name: gitlab-secret
  namespace: cicd
type: Opaque
stringData:
  password: "gL123456"
---
# 4. ConfigMap（gitlab.rb）
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-config
  namespace: cicd
data:
  gitlab.rb: |
    external_url 'http://gitlab.cicd.svc.cluster.local:80'
    gitlab_rails['gitlab_shell_ssh_port'] = 30022

    # === 复用外部 PG & Redis ===
    postgresql['enable'] = false
    gitlab_rails['db_adapter']  = 'postgresql'
    gitlab_rails['db_encoding'] = 'unicode'
    gitlab_rails['db_database'] = 'gitlab'
    gitlab_rails['db_pool']     = 10
    gitlab_rails['db_host']     = '10.0.1.245'   # 节点 IP
    gitlab_rails['db_port']     = 35432          # mid/postgres NodePort
    gitlab_rails['db_username'] = 'postgres'
    gitlab_rails['db_password'] = 'pPg123456'

    redis['enable'] = false
    gitlab_rails['redis_host'] = '10.0.1.245'
    gitlab_rails['redis_port'] = 32379           # mid/redis NodePort
    gitlab_rails['redis_password'] = 'rEdis123456_'

    # === 其余组件全开 ===
    nginx['enable'] = true
    registry['enable'] = true
    pages['enable'] = true
    gitlab_exporter['enable'] = true
    node_exporter['enable'] = true
    # 关闭内置 PG/Redis 相关 exporter
    redis_exporter['enable'] = false
    postgres_exporter['enable'] = false

    # Registry / Pages 外网地址
    registry_external_url 'http://10.0.1.245:30500'
    pages_external_url 'http://10.0.1.245:30501'

    # Prometheus 指标端口保持默认 9168
    gitlab_exporter['listen_port'] = 9168
---
# 5. Service
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  namespace: cicd
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
    name: http
  - port: 22
    targetPort: 22
    nodePort: 30022
    name: ssh
  - port: 5000
    targetPort: 5000
    nodePort: 30500
    name: registry
  - port: 8090
    targetPort: 8090
    nodePort: 30501
    name: pages
  # 额外暴露 GitLab exporter 给 mon/prometheus 抓取
  - port: 9168
    targetPort: 9168
    nodePort: 30168
    name: metrics
  selector: { app: gitlab }
---
# 6. Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  namespace: cicd
spec:
  replicas: 1
  selector:
    matchLabels: { app: gitlab }
  template:
    metadata:
      labels: { app: gitlab }
    spec:
      nodeSelector:
        kubernetes.io/hostname: izrj943cxeelu84r2mp9abz
      initContainers:
      - name: fix-perm
        image: busybox:1.36
        command: ['sh','-c','chown -R 998:998 /var/opt/gitlab']
        volumeMounts:
        - name: data
          mountPath: /var/opt/gitlab
      containers:
      - name: gitlab
        image: gitlab/gitlab-ce:17.7.0-ce.0
        ports:
        - containerPort: 80
          name: http
        - containerPort: 22
          name: ssh
        - containerPort: 5000
          name: registry
        - containerPort: 8090
          name: pages
        - containerPort: 9168
          name: metrics
        env:
        - name: GITLAB_OMNIBUS_CONFIG
          valueFrom:
            configMapKeyRef:
              name: gitlab-config
              key: gitlab.rb
        - name: GITLAB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: gitlab-secret
              key: password
        volumeMounts:
        - name: data
          mountPath: /var/opt/gitlab
        livenessProbe:
          httpGet: { path: /-/health, port: 80 }
          initialDelaySeconds: 180
          periodSeconds: 30
        readinessProbe:
          httpGet: { path: /-/readiness, port: 80 }
          initialDelaySeconds: 60
          periodSeconds: 15
        resources:
          requests: { cpu: "1", memory: "2Gi" }
          limits: { cpu: "2", memory: "4Gi" }
      volumes:
      - name: data
        persistentVolumeClaim: { claimName: gitlab-data }
```

add-prometheus-config.yaml

```
# 给 mon/prometheus 加抓取任务（apply 到 mon 空间即可）
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config-add
  namespace: mon
data:
  gitlab.yml: |
    scrape_configs:
      - job_name: 'gitlab'
        static_configs:
        - targets: ['10.0.1.245:30168']  # GitLab exporter NodePort
        metrics_path: /metrics
        scrape_interval: 15s
      - job_name: 'gitlab-pages'
        static_configs:
        - targets: ['10.0.1.245:30501']  # Pages 指标端口
        metrics_path: /metrics
        scrape_interval: 15s
```

```
# 1. 创建数据库（一次性）
kubectl -n mid exec -it deployment/postgres -- psql -U postgres -c "CREATE DATABASE gitlab OWNER postgres;"

# 2. 部署 GitLab（全部组件开启）
kubectl apply -f 01-gitlab-mon.yaml

# 3. 给 Prometheus 加抓取任务
kubectl -n mon patch configmap prometheus-config --patch "$(kubectl -n mon get cm prometheus-config-add -o json | jq '.data')"
# 或直接 kubectl apply -f 02-add-prometheus-config.yaml 然后重启 Prometheus Pod（发送 SIGHUP 或 delete Pod）
```



```
# GitLab 就绪
kubectl -n cicd get pod -l app=gitlab -w

# Prometheus 抓到新指标
curl http://10.0.1.245:30090/targets
# 应出现 gitlab、gitlab-pages UP 状态

# Grafana 导入模板
# 模板 ID 11016（GitLab Omnibus）或 10991（RabbitMQ）
```

| 功能            | 节点端口                    |
| --------------- | --------------------------- |
| GitLab Web      | 30080                       |
| Git SSH         | 30022                       |
| Registry        | 30500                       |
| Pages           | 30501                       |
| GitLab Exporter | 30168（仅 Prometheus 调用） |