添加 GitLab 官方 Chart 仓库

```
helm repo add gitlab https://charts.gitlab.io
helm repo update
```

部署 gitlab

```
helm upgrade --install gitlab-ce -n gitlab -f gitlab-local.yaml gitlab/gitlab --version 8.2.2
```

gitlab-local.yaml

```yaml
# GitLab CE 17.x 全外接最小化部署配置
# 特点：NodePort裸跑 + 外接PG/Redis/S3 + 无Ingress + 无cert-manager + 可选Runner/Prometheus/Grafana

############################## 一、全局控制 ##############################
global:
  edition: ce                                    # 社区版
  hosts:
    domain: 10.0.0.11                          # 节点IP，访问http://10.0.0.11:30080
  ingress:
    tls:
      enabled: false                             # 不挂TLS
  appConfig:
    monitoring:
      enabled: true                              # 打开指标，给外部Prometheus用
      ipWhitelist:
        - "10.0.0.0/8"                          # 放Prometheus网段

############################## 二、七层入口全关 ##############################
ingress:
  enabled: false                                 # 不生成本地Ingress对象
nginx-ingress:
  enabled: false                                 # 不装ingress-controller
certmanager:
  install: false                                 # 不装cert-manager
nginx:
  listen_https: false                            # 容器只监听80
  listen_port: 80

############################## 三、NodePort暴露 ##############################
service:
  gitlab:
    webservice:
      type: NodePort
      nodePort: 30080        # http入口
      https:
        nodePort: 30443      # 预留https（自签时开）
    registry:
      type: NodePort
      nodePort: 30500
    pages:
      type: NodePort
      nodePort: 30900
gitlab-shell:
  service:
    type: NodePort
    nodePort: 30022          # SSH clone端口

############################## 四、外部数据库 ##############################
postgresql:
  install: false
  external:
    host: pg.example.com
    port: 5432
    username: gitlab
    database: gitlabhq_production
    password:
      secret: gitlab-postgres
      key: password
redis:
  install: false
  external:
    host: redis.example.com
    port: 6379
    password:
      secret: gitlab-redis
      key: password

############################## 五、关闭EE组件 ##############################
kas:
  enabled: false
gitlab-exporter:
  enabled: false
sidekiq:
  ee:
    enabled: false

############################## 六、对象存储（外接MinIO/S3） ##############################
minio:
  enabled: false               # 禁用内置MinIO
# === 以下6个桶已提前在MinIO建好 ===
global:
  artifacts:
    enabled: true
    bucket: gitlab-artifacts
    connection:
      secret: gitlab-s3
      key: connection
  lfs:
    enabled: true
    bucket: gitlab-lfs
    connection:
      secret: gitlab-s3
      key: connection
  uploads:
    enabled: true
    bucket: gitlab-uploads
    connection:
      secret: gitlab-s3
      key: connection
  packages:
    enabled: true
    bucket: gitlab-packages
    connection:
      secret: gitlab-s3
      key: connection
  registry:
    enabled: true
    bucket: gitlab-registry
    connection:
      secret: gitlab-s3
      key: connection
  backups:
    enabled: true
    bucket: gitlab-backups
    connection:
      secret: gitlab-s3
      key: connection
  externalObjectStore:
    enabled: true
    proxy_download: true
    connection:
      secret: gitlab-s3
      key: connection   # 内容：provider=AWS region=us-east-1 aws_access_key_id=xxx aws_secret_access_key=xxx endpoint=http://minio.example.com:9000 path_style=true

############################## 七、可选组件 ##############################
prometheus:
  install: false          # 用外部Prometheus
grafana:
  enabled: false          # 用外部Grafana
gitlab-runner:
  install: true           # 需要CI就true
  gitlabUrl: "http://10.0.0.11:30080"
  runnerTokenSecret: gitlab-runner-token
  runnerTokenKey: runner-token
  runners:
    privileged: true      # docker-in-docker
############################## 八、资源瘦身 ##############################
gitlab:
  webservice:
    minReplicas: 1
  sidekiq:
    minReplicas: 1
  gitlab-shell:
    minReplicas: 1
```

```shell


# ⑤ 安装GitLab
helm repo add gitlab https://charts.gitlab.io
helm repo update
helm upgrade --install gitlab-ce -n gitlab -f gitlab-values.yaml gitlab/gitlab --version 8.2.2 --timeout 15m

# ⑥ 查看NodePort
kubectl -n gitlab get svc -l app=webservice

# ⑦ 获取root密码
kubectl -n gitlab get secret gitlab-ce-initial-root-password -ojsonpath='{.data.password}' | base64 -d
```







```yaml

```









```
kubectl run -it --rm debug --image=curlimages/curl -n mid -- curl http://minio.mid.svc.cluster.local:9000/minio/health/live



helm uninstall gitlab -n cicd

kubectl get pod -n cicd
```











准备本地持久化卷

```
mkdir -p /storage/gitlab-gitaly
chown -R 998:998 /storage/gitlab-gitaly
chmod 700 /storage/gitlab-gitaly
```



gitlab-local-pvc.yaml

```
# local-gitlab-gitaly
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-gitlab-gitaly
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
---
# gitlab-gitaly-pv
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-gitaly-pv
spec:
  capacity: {storage: 50Gi}
  accessModes: [ReadWriteOnce]
  storageClassName: local-gitlab-gitaly
  local: {path: /storage/gitlab-gitaly}
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
            - izrj943cxeelu8yy8nt47tz
```







```
# 配置 PG 密码
kubectl -n cicd create secret generic gitlab-postgres --from-literal=password=pG123456_

# 配置 Redis 密码
kubectl -n cicd create secret generic gitlab-redis --from-literal=password=rEdis123456_

# 配置 MinIO
kubectl -n cicd create secret generic gitlab-s3 --from-literal=connection="provider=MinIO region=whole aws_access_key_id=minio aws_secret_access_key=mInio123456_ endpoint=http://minio.mid.svc.cluster.local path_style=true"

# 启动后去 Web 界面拿真实 token 再 patch，Runner令牌（Web页http://10.0.0.11:30080/admin/runners拿token）
kubectl -n cicd create secret generic gitlab-runner-token --from-literal=runner-token=PLACEHOLDER

kubectl apply -f gitlab-local-pvc.yaml



# 安装
helm repo add gitlab https://charts.gitlab.io
helm repo update
helm install gitlab gitlab/gitlab -n cicd  --version 8.11.8 -f gitlab-local.yaml


helm upgrade -i gitlab gitlab/gitlab -n cicd -f gitlab-local.yaml --dry-run --debug
helm upgrade -i gitlab gitlab/gitlab -n cicd -f gitlab-local.yaml


helm uninstall gitlab -n cicd



```













https://docs.gitlab.com/charts/installation/deployment/

```
helm upgrade --install --namespace=gitlab gitlab gitlab/gitlab \
  --timeout 600s \
  --set global.hosts.domain=xxx.xxx.xxx\
  --set global.hosts.externalIP=47.88.85.25 \
  --set certmanager-issuer.email=me@example.com

若无域名
helm upgrade --install --namespace=gitlab gitlab gitlab/gitlab \
  --timeout 600s \
  --set global.ingress.enabled=false \
  --set gitlab.webservice.service.type=NodePort \
  --set gitlab.webservice.service.httpPort=30480 \
  --set gitlab.webservice.service.httpsPort=30443 \
  --set certmanager-issuer.email=me@example.com


kubectl get pod -n gitlab
kubectl describe -n gitlab pod  gitlab-webservice-default-6fcb4d4b9-9h6gw
kubectl logs -n gitlab gitlab-webservice-default-6fcb4d4b9-9h6gw

kubectl logs -n gitlab gitlab-webservice-default-6fcb4d4b9-9h6gw -c dependencies


kubectl get job -n gitlab
helm upgrade gitlab gitlab/gitlab \
  --namespace gitlab \
  --reuse-values \
  --wait --timeout 10m
  
  
helm uninstall gitlab -n gitlab

# helm upgrade --install gitlab gitlab/gitlab   --namespace=gitlab   --create-namespace   --timeout 600s   --set global.edition=ce   --set gitlab-runner.install=false   --set global.hosts.domain=example.com   --set certmanager-issuer.email=me@example.com

# job 的日志在 pod 中，找到 pod 然后查看日志
# kubectl get pod -n gitlab -l job-name=gitlab-migrations-526c1fd



kubectl exec -it -n gitlab deploy/gitlab-toolbox -- \
  gitlab-rails runner \
  "ApplicationSetting.current.update!(external_url: 'http://47.88.85.25:31603/')"
```





https://docs.gitlab.com/charts/installation/deployment

https://gitlab.com/gitlab-org/charts/gitlab/-/tree/v8.11.8/charts/gitlab
